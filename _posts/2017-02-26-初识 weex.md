---
layout: post
title: 初识 weex
date: 2017-02-26
categories: weex
---

# 什么是 weex
weex 是阿里开源的一套三端通用方案，只要编写一次代码就能运行在 iOS、Android 和 Web 上。这里是官网的介绍：
**Weex 是一套简单易用的跨平台开发方案，能以 web 的开发体验构建高性能、可扩展的 native 应用，为了做到这些，Weex 与 Vue 合作，使用 Vue 作为上层框架，并遵循 W3C 标准实现了统一的 JSEngine 和 DOM API，这样一来，你甚至可以使用其他框架驱动 Weex，打造三端一致的 native 应用。**
但是实际上，weex 是从阿里的 WeeApp 发展而来的，看开源之后 github 上面提交的记录，大部分工作都是 Web 连接原生组件的代码，原生组件早就写完了。

但是，由于这种版本升级似的改动，就造成了一些坑。一开始编写 weex 应用的源码文件扩展名是.we，后来，weex 跟 Vue.js 合作直接使用 .vue 文件作为源码，编写的方式也改为了 Vue 的格式。
局限在于，并不是所有 Web 特性都支持的，也可以说支持的特性很少并且坑很多。
![官方的特性支持列表]
(http://weex.apache.org/cn/references/web-standards.html)
目前 weex 正处于向 Vue 迁移的过程，许多文档和示例代码都比较旧，bug 也比较多，还不能作为正式的生产工具，最近 weex 正式成为了 Apache 孵化项目，希望能够成为 ReactNative 这样的成熟项目。

#开发 Hello World
##安装开发环境
安装过程还是非常友好的，按照官方的教程做就可以了:
**Weex 官方提供了 weex-toolkit 的脚手架工具来辅助开发和调试。首先，你需要 Node.js 和 weex-toolkit安装 Node.js 方式多种多样，最简单的方式是在 Node.js 官网 下载可执行程序直接安装即可。对于 Mac，可以使用 Homebrew 进行安装：**

```
brew install node
```
安装完成后，可以使用以下命令检测是否安装成功：

```
$ node -v
v6.3.1
$ npm -v
3.10.3
```
通常，安装了 Node.js 环境，npm 包管理工具也随之安装了。因此，直接使用 npm 来安装 weex-toolkit。
但是如果想用 .vue 的模板来编写，需要按照说明下载 beta 版本的才行！否则下载的环境生成的项目模板是 .we 的。
**weex-toolkit 目前仅有最新的 beta 版本开始才支持初始化 Vue 项目，使用前请确认版本是否正确。**

```
$ npm install -g weex-toolkit@beta
```

如果提示权限错误（permission error），使用 sudo 关键字进行安装

```
$ sudo cnpm install -g weex-toolkit@beta
```

##准备调试工具
调试需要 iOS/Android 真机和 Chrome 浏览器。阿里已经编写了一个原生 app 叫做 "Playground App"，可以下载使用，但是最好的办法还是自己搭建一个 app 毕竟最终还是要把 weex 整合到 app 中才行的。
iOS 的集成很简单：
1. 使用 cocoapods 安装 WXDevtool。
2. 初始化 weex 页面.

```
- (void)viewWillAppear:(BOOL)animated{
    self.wxInstance = [[WXSDKInstance alloc]init];
    self.wxInstance.viewController = self;
    self.wxInstance.frame = self.view.bounds;
    __weak typeof(self) weakSelf = self;
    self.wxInstance.onCreate = ^(UIView* view){
        [weakSelf.weexView removeFromSuperview];
        weakSelf.weexView = view;
        [view removeFromSuperview];
        [weakSelf.view addSubview:view];
    };
    

    self.wxInstance.onFailed = ^(NSError* error){
        weakSelf.wxInstance.viewController = nil;
    };
    self.wxInstance.renderFinish = ^(UIView* view){
        [weakSelf updateInstanceState:WeexInstanceAppear];
        NSLog(@"%@",view);
    };
//weex 运行起来之后,会把代码打包成一个 js bundle, 只要加载上就可以了,无论是从 weburl 还是从 fileurl 加载都是很方便的.    
//    [self.wxInstance renderWithURL:[NSURL URLWithString:@"http://192.168.25.85:8088/weex/foo.js"] options:@{@"bundleUrl":@"http://192.168.25.85:8088/weex/foo.js"} data:nil];
    [self.wxInstance renderWithURL:[NSURL fileURLWithPath:[[NSBundle mainBundle] pathForResource:@"foo" ofType:@"js"]]];
}
```
注意销毁，不要造成内存泄露。

```
- (void)dealloc{
    [self.wxInstance destroyInstance];
}
```
3. 修改 weex 状态
参考阿里的 demo，在自己的 app 里面也及时修改 weex 状态，状态的改变会直接回调到 javascript 的相应函数中。

```
- (void)viewDidAppear:(BOOL)animated
{
    [super viewDidAppear:animated];
    [self updateInstanceState:WeexInstanceAppear];
}

- (void)viewDidDisappear:(BOOL)animated
{
    [super viewDidDisappear:animated];
    [self updateInstanceState:WeexInstanceDisappear];
}

- (void)updateInstanceState:(WXState)state
{
    if (self.wxInstance && self.wxInstance.state != state) {
        self.wxInstance.state = state;
        
        if (state == WeexInstanceAppear) {
            [[WXSDKManager bridgeMgr] fireEvent:self.wxInstance.instanceId ref:WX_SDK_ROOT_REF type:@"viewappear" params:nil domChanges:nil];
        }
        else if (state == WeexInstanceDisappear) {
            [[WXSDKManager bridgeMgr] fireEvent:self.wxInstance.instanceId ref:WX_SDK_ROOT_REF type:@"viewdisappear" params:nil domChanges:nil];
        }
    }
}
```
这部分是参考 Demo 进行编写的。

##初始化项目


##开始进行调试